    - name: Check Rsyslog Services
      ansible.builtin.systemd:
        name: rsyslog.service
      register: rsyslog_service_status
    - name: Set fact from  Rsyslog Services
      set_fact:
        Siem_Status: "{{rsyslog_service_status.status.ActiveState | default('Unknown') }}"

    - name: Check /etc/rsyslog.conf file
      shell: "sha1sum /etc/rsyslog.conf"
      register: rsyslog_hash
      become: true
      become_user: root
    
    # Kiểm tra file backup đã tồn tại chưa
    - name: Kiểm tra backup file tồn tại chưa
      local_action:
        module: stat
        path: "/home/huytq/AutoSecOps/LogChecks/{{ inventory_hostname }}/tmp/sha_rsyslog.txt"
      register: backup_stat

    # Nếu chưa có file backup → tạo mới với giá trị hiện tại
    # - name: Tạo backup file lần đầu
    #   local_action:
    #     module: copy
    #     dest: "/home/huytq/AutoSecOps/LogChecks/{{ inventory_hostname }}/tmp/sha_rsyslog.txt"
    #     content: "{{ rsyslog_hash.stdout }}"
    #   when: not backup_stat.stat.exists
    #   run_once: false   # chạy cho từng host riêng
    
    - name: Tạo backup file lần đầu (tự tạo thư mục nếu chưa có)
      ansible.builtin.shell: |
        mkdir -p /home/huytq/AutoSecOps/LogChecks/{{ inventory_hostname }}/tmp && \
        echo "{{ rsyslog_hash.stdout }}" > /home/huytq/AutoSecOps/LogChecks/{{ inventory_hostname }}/tmp/sha_rsyslog.txt
      delegate_to: localhost
      when: not backup_stat.stat.exists
      run_once: false   # chạy cho từng host riêng

    # Load nội dung file backup (nếu có)
    - name: Load rsyslog_hash backup file
      local_action:
        module: shell
        cmd: 'cat /home/huytq/AutoSecOps/LogChecks/{{ inventory_hostname }}/tmp/sha_rsyslog.txt'
      register: file_content
      when: backup_stat.stat.exists

    - name: Load rsyslog_hash backup file
      local_action:
        module: shell
        cmd: 'cat /home/huytq/AutoSecOps/LogChecks/{{ inventory_hostname }}/tmp/sha_rsyslog.txt'
      register: file_content
    
    - name: Compare Content
      set_fact:
        is_change_config: >-
          {%- if not backup_stat.stat.exists -%}
            First calculate hash rsyslog file
          {%- elif file_content.stdout == rsyslog_hash.stdout -%}
            "Same content"
          {%- elif file_content.stdout == "ERROR" -%}
              "Please update file content for the first time"
          {%- elif rsyslog_hash.stdout == "ERROR" -%}
              "Error when run sha1sum /etc/rsyslog.conf"
          {%- else -%}
               "Rsyslog.conf different with backup file"
          {%- endif -%}
      ignore_errors: true

    - name: Compare Content Debug
      debug: 
        msg: "Back up content {{file_content.stdout}} : Current content {{rsyslog_hash.stdout}}"
      when: mode == "dev"
